<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TGD Redirect Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white shadow rounded p-6">

    <h1 class="text-2xl font-bold mb-4">Redirect Admin</h1>

    <!-- LOGIN -->
    <div id="loginBox" class="mb-6">
      <input id="tokenInput" type="password"
        placeholder="GitHub Personal Access Token"
        class="border p-2 w-full mb-2">
      <button onclick="login()"
        class="bg-blue-600 text-white px-4 py-2 rounded">
        Login
      </button>
    </div>

    <!-- CONTROLS -->
    <div id="controls" class="hidden mb-4 flex gap-2">
      <input id="searchInput" placeholder="Search..."
        class="border p-2 flex-1">
      <button onclick="openNew()"
        class="bg-green-600 text-white px-4 py-2 rounded">
        New Link
      </button>
      <button onclick="loadLinks()"
        class="bg-gray-600 text-white px-4 py-2 rounded">
        Refresh
      </button>
    </div>

    <!-- LIST -->
    <div id="list" class="space-y-2"></div>
  </div>

<script>
/* ================= CONFIG ================= */

const OWNER = "thegreekdirectory";
const REPO = "links";
const LINKS_JSON = "data/links.json";
const TEMPLATE_PATH = "r/_template.html";
const REDIRECT_DIR = "r";

let token = "";
let links = [];

/* ================= AUTH ================= */

function login() {
  token = tokenInput.value.trim();
  if (!token) return alert("Token required");
  loginBox.classList.add("hidden");
  controls.classList.remove("hidden");
  loadLinks();
}

/* ================= HELPERS ================= */

function gh(path) {
  return fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`,
    { headers: { Authorization: `token ${token}` } }
  );
}

function requireValidPath(path) {
  if (!path.startsWith("/r/")) {
    alert("Path must start with /r/");
    return false;
  }
  return true;
}

function requireValidURL(url) {
  if (!url.startsWith("https://")) {
    alert("Redirect URL must start with https://");
    return false;
  }
  return true;
}

function slugFromPath(path) {
  return path.replace("/r/", "");
}

/* ================= LOAD ================= */

async function loadLinks() {
  const res = await gh(LINKS_JSON);
  const file = await res.json();
  links = JSON.parse(atob(file.content)).links;
  render();
}

/* ================= RENDER ================= */

function render() {
  const q = searchInput.value.toLowerCase();
  list.innerHTML = "";

  links
    .filter(l =>
      l.title.toLowerCase().includes(q) ||
      l.path.toLowerCase().includes(q) ||
      l.redirectTo.toLowerCase().includes(q)
    )
    .forEach(l => {
      list.innerHTML += `
        <div class="border rounded p-3 flex justify-between items-center">
          <div>
            <div class="font-semibold">${l.title}</div>
            <div class="text-sm text-gray-600">
              ${l.path} â†’ ${l.redirectTo}
            </div>
          </div>
          <div class="space-x-3">
            <button onclick="editLink('${l.id}')" class="text-blue-600">Edit</button>
            <button onclick="deleteLink('${l.id}')" class="text-red-600">Delete</button>
          </div>
        </div>
      `;
    });
}

/* ================= TEMPLATE ================= */

async function loadTemplate() {
  const res = await gh(TEMPLATE_PATH);
  const file = await res.json();
  return atob(file.content);
}

/* ================= FILE OPS ================= */

async function writeRedirect(path, redirectTo) {
  const slug = slugFromPath(path);
  const filePath = `${REDIRECT_DIR}/${slug}.html`;

  let html = await loadTemplate();
  html = html.replaceAll("{{REDIRECT_URL}}", redirectTo);

  const content = btoa(html);

  let sha = null;
  const check = await gh(filePath);
  if (check.ok) sha = (await check.json()).sha;

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
    {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Write redirect page",
        content,
        ...(sha && { sha })
      })
    }
  );
}

async function removeRedirect(path) {
  const slug = slugFromPath(path);
  const filePath = `${REDIRECT_DIR}/${slug}.html`;

  const res = await gh(filePath);
  if (!res.ok) return;

  const file = await res.json();

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
    {
      method: "DELETE",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Delete redirect page",
        sha: file.sha
      })
    }
  );
}

/* ================= SAVE JSON ================= */

async function saveJSON() {
  const res = await gh(LINKS_JSON);
  const file = await res.json();

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${LINKS_JSON}`,
    {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update links.json",
        content: btoa(JSON.stringify({ links }, null, 2)),
        sha: file.sha
      })
    }
  );

  loadLinks();
}

/* ================= CRUD ================= */

async function openNew() {
  const title = prompt("Title");
  const path = prompt("Path (must start with /r/)");
  const redirectTo = prompt("Redirect URL (https://...)");

  if (!title || !path || !redirectTo) return;
  if (!requireValidPath(path) || !requireValidURL(redirectTo)) return;

  const link = {
    id: crypto.randomUUID(),
    title,
    path,
    redirectTo
  };

  links.push(link);
  await writeRedirect(path, redirectTo);
  await saveJSON();
}

async function editLink(id) {
  const link = links.find(l => l.id === id);
  const oldPath = link.path;

  link.title = prompt("Title", link.title);
  link.path = prompt("Path", link.path);
  link.redirectTo = prompt("Redirect URL", link.redirectTo);

  if (!requireValidPath(link.path) || !requireValidURL(link.redirectTo)) return;

  if (oldPath !== link.path) {
    await removeRedirect(oldPath);
  }

  await writeRedirect(link.path, link.redirectTo);
  await saveJSON();
}

async function deleteLink(id) {
  if (!confirm("Delete this redirect?")) return;

  const index = links.findIndex(l => l.id === id);
  const link = links[index];

  await removeRedirect(link.path);
  links.splice(index, 1);
  await saveJSON();
}

/* ================= EVENTS ================= */

searchInput.addEventListener("input", render);
</script>

</body>
</html>
