<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TGD Shortlinks Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
<div class="max-w-6xl mx-auto bg-white shadow rounded p-6">

<h1 class="text-2xl font-bold mb-4">Shortlinks Admin</h1>

<!-- LOGIN -->
<div id="loginBox" class="mb-6">
  <input id="tokenInput" type="password"
    placeholder="GitHub Personal Access Token"
    class="border p-2 w-full mb-2">
  <button onclick="login()"
    class="bg-blue-600 text-white px-4 py-2 rounded">
    Login
  </button>
</div>

<!-- CONTROLS -->
<div id="controls" class="hidden mb-4 flex gap-2">
  <input id="searchInput" placeholder="Search..."
    class="border p-2 flex-1">
  <button onclick="openNew()" class="bg-green-600 text-white px-4 py-2 rounded">
    New Link
  </button>
  <input type="file" id="csvInput" accept=".csv"
    class="border p-2">
  <button onclick="loadLinks()" class="bg-gray-600 text-white px-4 py-2 rounded">
    Refresh
  </button>
</div>

<div id="list" class="space-y-2"></div>

</div>

<script>
/* ================= CONFIG ================= */

const OWNER = "thegreekdirectory";
const REPO = "shortlinks-tgd.gr";
const LINKS_JSON = "links.json";
const TEMPLATE_PATH = "template.html";

let token = "";
let links = [];

/* ================= AUTH ================= */

function login() {
  token = tokenInput.value.trim();
  if (!token) return alert("Token required");
  loginBox.classList.add("hidden");
  controls.classList.remove("hidden");
  loadLinks();
}

/* ================= HELPERS ================= */

function gh(path) {
  return fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`,
    { headers: { Authorization: `token ${token}` } }
  );
}

function requireValidURL(url) {
  if (!url.startsWith("https://")) {
    alert("Redirect URL must start with https://");
    return false;
  }
  return true;
}

function fileFromPath(path) {
  return `${path.replace(/^\/+/, "")}.html`;
}

/* ================= LOAD ================= */

async function loadLinks() {
  const res = await gh(LINKS_JSON);
  const file = await res.json();
  links = JSON.parse(atob(file.content)).links;
  render();
}

/* ================= RENDER ================= */

function render() {
  const q = searchInput.value.toLowerCase();
  list.innerHTML = "";

  links
    .filter(l =>
      l.title.toLowerCase().includes(q) ||
      l.path.toLowerCase().includes(q) ||
      l.redirectTo.toLowerCase().includes(q)
    )
    .forEach(l => {
      list.innerHTML += `
        <div class="border rounded p-3 flex justify-between">
          <div>
            <div class="font-semibold">${l.title}</div>
            <div class="text-sm text-gray-600">
              /${l.path} â†’ ${l.redirectTo}
            </div>
          </div>
          <div class="space-x-3">
            <button onclick="editLink('${l.id}')" class="text-blue-600">Edit</button>
            <button onclick="deleteLink('${l.id}')" class="text-red-600">Delete</button>
          </div>
        </div>
      `;
    });
}

/* ================= TEMPLATE ================= */

async function loadTemplate() {
  const res = await gh(TEMPLATE_PATH);
  const file = await res.json();
  return atob(file.content);
}

/* ================= FILE OPS ================= */

async function writeRedirect(path, redirectTo) {
  const filePath = fileFromPath(path);
  let html = await loadTemplate();
  html = html.replaceAll("{{REDIRECT_URL}}", redirectTo);

  const content = btoa(html);

  let sha = null;
  const check = await gh(filePath);
  if (check.ok) sha = (await check.json()).sha;

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
    {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Write redirect",
        content,
        ...(sha && { sha })
      })
    }
  );
}

async function removeRedirect(path) {
  const filePath = fileFromPath(path);
  const res = await gh(filePath);
  if (!res.ok) return;
  const file = await res.json();

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
    {
      method: "DELETE",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Delete redirect",
        sha: file.sha
      })
    }
  );
}

/* ================= SAVE JSON ================= */

async function saveJSON() {
  const res = await gh(LINKS_JSON);
  const file = await res.json();

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${LINKS_JSON}`,
    {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update links.json",
        content: btoa(JSON.stringify({ links }, null, 2)),
        sha: file.sha
      })
    }
  );

  loadLinks();
}

/* ================= CRUD ================= */

async function openNew() {
  const title = prompt("Title");
  const path = prompt("Path (no leading slash)");
  const redirectTo = prompt("Redirect URL (https://...)");

  if (!title || !path || !redirectTo) return;
  if (!requireValidURL(redirectTo)) return;

  const link = {
    id: crypto.randomUUID(),
    title,
    path,
    redirectTo
  };

  links.push(link);
  await writeRedirect(path, redirectTo);
  await saveJSON();
}

async function editLink(id) {
  const link = links.find(l => l.id === id);
  const oldPath = link.path;

  link.title = prompt("Title", link.title);
  link.path = prompt("Path", link.path);
  link.redirectTo = prompt("Redirect URL", link.redirectTo);

  if (!requireValidURL(link.redirectTo)) return;

  if (oldPath !== link.path) await removeRedirect(oldPath);
  await writeRedirect(link.path, link.redirectTo);
  await saveJSON();
}

async function deleteLink(id) {
  if (!confirm("Delete this redirect?")) return;

  const i = links.findIndex(l => l.id === id);
  await removeRedirect(links[i].path);
  links.splice(i, 1);
  await saveJSON();
}

/* ================= CSV UPLOAD ================= */

csvInput.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();

  const rows = text
    .split("\n")
    .map(r => r.trim())
    .filter(Boolean);

  // Remove header
  rows.shift();

  const newLinks = [];

  for (const row of rows) {
    const [title, path, redirectTo] = row
      .split(",")
      .map(v => v.trim());

    if (!title || !path || !redirectTo) continue;
    if (!requireValidURL(redirectTo)) continue;

    // Prevent duplicates
    if (links.some(l => l.path === path)) continue;

    const link = {
      id: crypto.randomUUID(),
      title,
      path,
      redirectTo
    };

    newLinks.push(link);
  }

  if (!newLinks.length) {
    alert("No valid links found in CSV");
    return;
  }

  // Write redirects sequentially (safe)
  for (const l of newLinks) {
    await writeRedirect(l.path, l.redirectTo);
    links.push(l);
  }

  await saveJSON();
  alert(`Imported ${newLinks.length} shortlinks`);
});


searchInput.addEventListener("input", render);
</script>
</body>
</html>
